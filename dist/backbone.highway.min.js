!function(a,b){"use strict";"function"==typeof define&&define.amd?define(["backbone","underscore"],function(c,d){return b(a,c||a.Backbone,d||a._)}):"object"==typeof exports?module.exports=b(a,require("backbone"),require("underscore")):b(a,a.Backbone,a._)}(this,function(a,b,c){"use strict";var d=a.localStorage,e=null,f={},g={},h={},i={},j={},k=[],l={headingSlash:/^(\/|#)/,trailingSlash:/\/$/,parentheses:/[\(\)]/g,optionalParams:/\((.*?)\)/g,splatParams:/\*\w+/g,namedParam:/(\(\?)?:\w+/},m={pushState:!0,root:"",hashChange:!0,silent:!1,dispatcher:null,authenticated:!1,redirectToLogin:!1,routes:{login:"login",error404:"404",error403:"403"},store:{prefix:"backbone-highway",separator:":"},debug:!1,log:function(){this.debug&&a.console&&a.console.log&&a.console.log.apply(a.console,arguments)}},n=function(a){if(!c.isFunction(a))throw this.options.log("[Backbone.Highway.map] Missing routes definer method as the first parameter"),new TypeError("[Backbone.Highway.map] First and only argument should be a function, instead got "+typeof a);return a.call(this)},o=function(){};return o.prototype={currentRoutes:[],start:function(a){this.options=c.extend({},m,a),this.options.routes=c.extend({},m.routes,this.options.routes),this.dispatcher=this.options.dispatcher,this.options.log("[Backbone.Highway.start] Starting router");var d=b.Router.extend(c.extend({},h,{routes:f}));e=new d,this._startHistory()},map:n,define:n,declare:n,route:function(a,b){var d=this,k={},l={},m=a;if(!c.isString(a))throw new ReferenceError("[Backbone.Highway.route] Route name should be a string");if(!c.isObject(b))throw new ReferenceError("[Backbone.Highway.route] Route definition needs to be an object");b.path&&(b.path=this._stripHeadingSlash(b.path)),b.path&&f[b.path]?a=f[b.path]:(g[b.path]=[],i[a]={re:c.isString(b.path)?this._routeToRegExp(b.path):null,wrappers:[]},k[b.path]=a,l[a]=function(){d._processControllers({name:a,args:arguments})},c.extend(f,k),c.extend(h,l),null!==e&&b.path&&e.route(b.path,a,l[a])),b.close&&(j[m]=b.close);var n=function(a,e){return e||d.currentRoutes.push(m),!c.isUndefined(b.authenticated)&&(b.authenticated&&!d.options.authenticated||!b.authenticated&&d.options.authenticated)?(d.options.redirectToLogin&&!d.options.authenticated?(d.options.log("[Backbone.Highway] Secured page, redirecting to login"),d._storeCurrentRoute(),d._processControllers({name:d.options.routes.login})):(d.options.log('[Backbone.Highway] Skipping route "'+m+'", '+(d.options.authenticated?"already ":"not ")+"logged in"),this._httpError(403)),!1):c.isString(b.action)?(d.options.log('[Backbone.Highway] Caught alias route: "'+m+'" >> "'+b.action+'"'),d._processControllers({name:b.action,args:a},!0),!1):(d.options.log('[Backbone.Highway] Executing route named "'+m+'"'),c.isEmpty(b.before)||d._processTriggers(b.before,a),c.isFunction(b.action)&&b.action.apply(d,a),c.isEmpty(b.after)||d._processTriggers(b.after,a),!0)};return g[b.path].push(m),i[a].wrappers.push(n),a!==m&&(i[m]={re:null,wrappers:[n]}),!0},go:function(a,b,d){var f=null,g=null;if(c.isObject(a)&&(f=a,a=f.name,c.isString(f.path)&&(g=this._stripHeadingSlash(f.path)),b=f.args||b),!a&&null===g)return this.options.log("[Backbone.Highway.go] Missing parameters, name or path is necessary"),!1;if(a&&!this._exists({name:a})||g&&!this._exists({path:g}))return this.options.log("[Backbone.Highway] Inexisting route name: "+a),this._httpError(404),!1;var h=!0;return c.forEach(this.currentRoutes,c.bind(function(e){c.isFunction(j[e])&&a!==e&&(h=j[e].call(this,a,b,d))},this)),h?(this.currentRoutes=[],d=c.extend({trigger:!0,replace:!1},d),g||(g=this._path(a,b)),g!==!1&&e.navigate(g,d),!0):!1},clearCache:function(){return k=[],!0},_processTriggers:function(a,b){var d=this;c.isArray(a)||(a=[a]),c.forEach(a,function(a){d._processTrigger(a,b)})},_processTrigger:function(a,b){if(c.isObject(a)){if(a.path&&(a.name=this._name(a.path)),a.cache&&this._cacheTrigger(a))return;if(c.isUndefined(a.args)||c.isNull(a.args)||c.isArray(a.args)||(a.args=[a.args]),c.isEmpty(a.args)&&(a.args=b),a.name&&this._exists({name:a.name}))return void this._processControllers(a,!0);var d=[a.name];c.forEach(a.args,function(a){d.push(a)}),this.hasDispatcher()&&this.dispatcher.trigger.apply(this.dispatcher,d)}else c.isString(a)?this._exists({name:a})?this._processControllers({name:a,args:b},!0):this.hasDispatcher()&&this.dispatcher.trigger.call(this.dispatcher,a):this.options.log("[Backbone.Highway._processTrigger] Bad trigger format, needs to be a string or an object, given: "+typeof a)},_processControllers:function(a,b){var d=this,e=a.name,f=a.args;return b=b||!1,i[e]?(a.path&&(f=this._extractParameters(e,a.path),1===f.length&&null===f[0]&&(f=a.args)),f=this._sanitizeArgs(f),c.forEach(i[e].wrappers,function(a){a.call(d,f,b)}),!0):(this.options.log("[Backbone.Highway._processControllers] Inexisting controller: "+e),!1)},_findCachedTrigger:function(a){var b=c.find(k,function(b){return b.name===a.name});return b?b:(k.push(c.extend({},a)),this._findCachedTrigger(a))},_cacheTrigger:function(a){var b=this._findCachedTrigger(a);return b.done?(this.options.log("[Backbone.Highway] Trigger [ "+(a.name||a.path)+" ] has been skipped (cached)"),!0):(b.done=!0,!1)},_startHistory:function(){if(!b.History.started){this.options.log("[Backbone.Highway.start] Starting Backbone.history ("+(this.options.root?"root: "+this.options.root:"empty root url")+")");var a=b.history.start({pushState:this.options.pushState,root:this.options.root,hashChange:this.options.hashChange,silent:this.options.silent});a||this.options.silent?this._applyStoredRoute():this._httpError(404)}},hasDispatcher:function(){return this.dispatcher&&c.isFunction(this.dispatcher.trigger)},_httpError:function(a){var c=b.history.getFragment();if(this.options.log("[Backbone.Highway] Inexisting route: "+c),404!==a&&403!==a)throw new Error("[Backbone.Highway] Unhandled http error code: "+a);return this._processControllers({name:this.options.routes["error"+a],args:[c]})},_applyStoredRoute:function(){var a=this._getStoredRoute();a&&(this.options.log("[Backbone.Highway] Loaded stored route: "+a),this._clearStore(),this.go({path:a}))},_path:function(a,b){var c;for(c in f)if(f[c]===a)return this._parse(c,b);return!1},_name:function(a){var b;a=this._stripHeadingSlash(a);for(b in i)if(i[b].re&&i[b].re.test(a))return b;return!1},_exists:function(a){return c.isObject(a)&&(!c.isUndefined(i[a.name])||this._name(a.path)!==!1)},_parse:function(a,b){if(!this._isValidArgsArray(b))return a=a.replace(l.optionalParams,""),this._checkPath(a),a;var d=this;return c.forEach(this._sanitizeArgs(b),function(b){a=d._replaceArg(a,b)}),c.forEach(a.match(l.optionalParams),function(b){(l.namedParam.test(b)||l.splatParams.test(b))&&(a=a.replace(b,""))}),a=a.replace(l.parentheses,"").replace(l.trailingSlash,""),this._checkPath(a),a},_replaceArg:function(a,b){return-1!==a.indexOf(":")?a.replace(l.namedParam,b):a.replace(l.splatParams,b)},_checkPath:function(a){if(l.namedParam.test(a)||l.splatParams.test(a))throw new ReferenceError("[Backbone.Highway._parse] Missing necessary arguments for path");return!0},_sanitizeArgs:function(a){return c.isObject(a)||c.isArray(a)||(a=[a]),c.without(a,null,void 0)},_isValidArgsArray:function(a){return!c.isEmpty(this._sanitizeArgs(a))},_storeCurrentRoute:function(){var a=b.history.getFragment();return this.options.log("[Backbone.Highway] Storing current path: "+a),d?(d.setItem(this._getStoreKey("path"),a),!0):!1},_getStoreKey:function(a){return this.options.store.prefix+this.options.store.separator+a},_getStoredRoute:function(){return d&&d.getItem(this._getStoreKey("path"))},_clearStore:function(){return d?(d.removeItem(this._getStoreKey("path")),!0):!1},_stripHeadingSlash:function(a){return c.isString(a)&&a.replace(l.headingSlash,"")},_extractParameters:function(a,c){return b.Router.prototype._extractParameters(i[a].re,this._stripHeadingSlash(c))},_routeToRegExp:function(a){return b.Router.prototype._routeToRegExp(a)},on:function(){return e&&e.on.apply(e,arguments)},off:function(){return e&&e.off.apply(e,arguments)},trigger:function(){return e&&e.trigger.apply(e,arguments)}},b.Highway=new o,b.Highway});
//# sourceMappingURL=backbone.highway.min.map